# Phase 2 开发路线图

**规划日期**: 2025-11-02
**目标**: 从原型到可用产品，完善核心功能和用户体验

---

## 📊 当前状态评估

### ✅ Phase 1 已完成 (基础协议和架构)

**核心系统**:
- ✅ 游戏协议完整定义 (TypeScript + Python)
- ✅ 游戏引擎基础实现 (流式/非流式)
- ✅ 工具调用系统 (9个核心工具)
- ✅ 前端游戏界面 (React + Next.js)
- ✅ 世界脚手架系统 (世界生成 + 场景细化)
- ✅ 目录结构重组 (清晰的分层架构)

**技术栈**:
- ✅ LiteLLM + DeepSeek V3 集成
- ✅ FastAPI 后端分层架构
- ✅ Next.js 14 + shadcn/ui 前端
- ✅ SQLite 数据库

### ⚠️ 现有问题和技术债务

**1. 功能完整性**
- ⚠️ 存档系统仅在前端实现（LocalStorage）
- ⚠️ 任务系统定义完整但缺少动态生成逻辑
- ⚠️ 全局导演系统框架存在但未完全实现
- ⚠️ NPC系统定义但缺少按需生成机制
- ⚠️ 事件线评分系统未实现

**2. 用户体验**
- ⚠️ 缺少新手引导和教程
- ⚠️ 没有错误恢复机制
- ⚠️ 界面反馈不够友好
- ⚠️ 缺少游戏进度可视化

**3. 性能和稳定性**
- ⚠️ 没有缓存机制（重复请求LLM）
- ⚠️ 缺少请求限流和错误重试
- ⚠️ 没有性能监控
- ⚠️ 会话管理简单（内存存储）

**4. 测试覆盖**
- ⚠️ 缺少单元测试
- ⚠️ 端到端测试不完整
- ⚠️ 没有性能测试

---

## 🎯 Phase 2 目标

### 总体目标
将项目从**可演示的原型**提升到**可用的MVP产品**

### 成功标准
1. ✅ 用户可以完整体验一个30分钟的游戏流程
2. ✅ 系统稳定性达到95%以上
3. ✅ 核心功能完整且经过测试
4. ✅ 用户体验流畅，错误友好
5. ✅ 代码质量达到生产级别

---

## 📋 Phase 2 功能清单

### 优先级定义
- **P0 (Critical)**: 阻塞MVP发布的功能
- **P1 (High)**: 重要但不阻塞发布
- **P2 (Medium)**: 增强体验的功能
- **P3 (Low)**: 锦上添花的功能

---

## 🚀 Sprint 1: 核心功能完善 (2周)

### P0: 存档系统后端实现

**目标**: 实现可靠的游戏存档功能

**任务**:
- [ ] 设计存档数据库schema
  - 表: `game_saves` (id, user_id, slot_id, game_state, metadata, created_at, updated_at)
  - 表: `save_snapshots` (存档快照，用于回滚)
- [ ] 实现存档API
  - `POST /api/game/save` - 保存游戏
  - `GET /api/game/saves` - 获取存档列表
  - `GET /api/game/save/{id}` - 加载存档
  - `DELETE /api/game/save/{id}` - 删除存档
  - `POST /api/game/save/{id}/snapshot` - 创建快照
- [ ] 实现自动保存逻辑
  - 每3个回合自动保存
  - 关键节点（任务完成、重大决策）自动保存
- [ ] 前端集成
  - 更新 `use-game-state.ts` 使用后端API
  - 添加存档槽位管理UI
  - 添加快速存档/读档快捷键

**验收标准**:
- ✅ 用户可以保存/加载游戏
- ✅ 支持多个存档槽位（至少3个）
- ✅ 自动保存在后台运行
- ✅ 存档包含完整游戏状态
- ✅ 测试覆盖率 > 80%

---

### P0: 任务系统动态生成

**目标**: 根据玩家进度动态生成任务

**任务**:
- [ ] 设计任务生成框架
  - 任务模板系统 (主线/支线/隐藏)
  - 任务依赖图
  - 任务触发条件
- [ ] 实现任务生成器
  - `QuestGenerator` 类
  - 基于世界状态生成任务
  - 基于玩家行为生成任务
- [ ] 实现任务追踪
  - 任务进度更新
  - 任务完成检测
  - 奖励发放
- [ ] 前端集成
  - 任务列表UI
  - 任务追踪提示
  - 任务完成动画

**验收标准**:
- ✅ 游戏开始时自动生成主线任务
- ✅ 玩家探索时触发支线任务
- ✅ 任务进度实时更新
- ✅ 任务完成有明确反馈
- ✅ 至少包含10个任务模板

---

### P1: 错误处理和恢复

**目标**: 提升系统稳定性和用户体验

**任务**:
- [ ] 统一错误处理机制
  - 定义错误类型和错误码
  - 实现全局错误处理器
  - 错误日志记录
- [ ] 实现请求重试机制
  - LLM请求失败自动重试（最多3次）
  - 指数退避策略
  - 降级处理（使用备用模型）
- [ ] 实现错误恢复
  - 工具调用失败回滚
  - 状态不一致检测和修复
  - 用户友好的错误提示
- [ ] 前端错误处理
  - 网络错误提示
  - 加载状态管理
  - 错误边界组件

**验收标准**:
- ✅ LLM请求失败不会导致游戏崩溃
- ✅ 所有错误都有友好的提示信息
- ✅ 自动重试成功率 > 90%
- ✅ 错误日志完整可追溯

---

### P1: 新手引导系统

**目标**: 帮助新用户快速上手

**任务**:
- [ ] 设计引导流程
  - 欢迎页面
  - 交互式教程（5-10分钟）
  - 游戏机制说明
- [ ] 实现引导步骤
  - 分步提示系统
  - 高亮交互元素
  - 进度追踪
- [ ] 创建示例游戏
  - 预设的简单场景
  - 引导式对话
  - 清晰的目标
- [ ] 帮助系统
  - 游戏内帮助文档
  - 快捷键说明
  - FAQ

**验收标准**:
- ✅ 新用户可以在10分钟内理解游戏玩法
- ✅ 引导步骤清晰且可跳过
- ✅ 示例游戏完整且有趣
- ✅ 帮助文档易于访问

---

## 🎨 Sprint 2: 用户体验优化 (2周)

### P0: 游戏进度可视化

**目标**: 让玩家清楚了解游戏进度

**任务**:
- [ ] 实现地图系统
  - 已探索/未探索区域标记
  - 当前位置高亮
  - 可用路径显示
- [ ] 实现任务追踪器
  - 活跃任务列表
  - 任务进度条
  - 完成任务历史
- [ ] 实现统计面板
  - 游戏时长
  - 探索进度
  - 成就系统（基础版本）
- [ ] 时间线可视化
  - 游戏事件时间轴
  - 关键决策回顾
  - 分支路线显示

**验收标准**:
- ✅ 地图清晰展示探索进度
- ✅ 任务追踪器实时更新
- ✅ 统计数据准确完整
- ✅ 界面美观且响应式

---

### P1: 性能优化

**目标**: 提升响应速度和用户体验

**任务**:
- [ ] 实现缓存机制
  - LLM响应缓存（相同输入）
  - 世界状态缓存
  - 静态资源缓存
- [ ] 优化数据库查询
  - 添加索引
  - 查询优化
  - 连接池管理
- [ ] 前端性能优化
  - 代码分割
  - 懒加载
  - 图片优化
- [ ] 实现请求限流
  - 速率限制
  - 队列管理
  - 优先级调度

**验收标准**:
- ✅ 平均响应时间 < 2秒
- ✅ LLM请求减少30%（通过缓存）
- ✅ 首屏加载时间 < 3秒
- ✅ 并发请求处理能力 > 10 QPS

---

### P1: 界面改进

**目标**: 提升界面美观度和易用性

**任务**:
- [ ] 重新设计聊天界面
  - 更清晰的消息区分（旁白/行动/提示）
  - 更好的输入框体验
  - 历史消息折叠
- [ ] 改进状态显示
  - 美化属性面板
  - 动画效果
  - 状态变化提示
- [ ] 添加音效和背景音乐
  - 环境音效
  - 交互反馈音效
  - 可选背景音乐
- [ ] 响应式设计改进
  - 移动端适配
  - 平板适配
  - 不同分辨率适配

**验收标准**:
- ✅ 界面美观现代
- ✅ 交互流畅自然
- ✅ 移动端体验良好
- ✅ 音效增强沉浸感（可关闭）

---

## 🔧 Sprint 3: 高级功能实现 (2周)

### P1: NPC系统实现

**目标**: 实现动态NPC生成和交互

**任务**:
- [ ] 设计NPC生成机制
  - NPC模板系统
  - 属性生成器
  - 性格特征系统
- [ ] 实现NPC生命周期
  - seed（种子） → instantiate（实例化）
  - engage（互动） → adapt（适应）
  - retire（退场）
- [ ] 实现NPC对话系统
  - 对话树生成
  - 记忆系统（记住玩家行为）
  - 关系系统（好感度）
- [ ] NPC行为AI
  - 基于目标的行为
  - 对玩家行为的反应
  - 自主行动

**验收标准**:
- ✅ NPC在合适时机出现
- ✅ NPC对话自然且有个性
- ✅ NPC会记住玩家互动
- ✅ NPC行为符合逻辑

---

### P2: 事件线评分系统

**目标**: 实现智能的事件选择和评分

**任务**:
- [ ] 设计评分维度
  - 可玩性评分（互动性、选择性）
  - 叙事评分（戏剧性、连贯性）
  - 混合评分（可玩性 + 叙事）
- [ ] 实现评分算法
  - 事件前置条件检查
  - 事件影响评估
  - 玩家偏好学习
- [ ] 实现事件选择器
  - 基于评分选择下一个事件
  - 事件多样性保证
  - 避免重复和单调
- [ ] 集成到游戏引擎
  - 自动事件推进
  - 玩家选择影响评分
  - 动态难度调整

**验收标准**:
- ✅ 事件选择符合玩家偏好
- ✅ 游戏节奏合理
- ✅ 避免重复事件
- ✅ 难度自适应调整

---

### P2: 线索经济管理

**目标**: 实现伏笔和线索系统

**任务**:
- [ ] 设计线索系统
  - 线索类型（隐式/显式/红鲱鱼）
  - 线索SLA（伏笔必须在N回合内揭晓）
  - 证据链验证
- [ ] 实现线索追踪
  - 线索登记册
  - 伏笔债务管理
  - 线索健康度监控
- [ ] 实现一致性检查
  - 硬规则检查（物理定律）
  - 因果检查（逻辑一致性）
  - 资源检查（物品消耗）
- [ ] 前端展示
  - 线索笔记本
  - 已发现线索列表
  - 线索关系图

**验收标准**:
- ✅ 伏笔在SLA内揭晓
- ✅ 线索逻辑一致
- ✅ 玩家可以追踪线索
- ✅ 一致性错误 < 5%

---

## 🧪 Sprint 4: 测试和优化 (1周)

### P0: 测试覆盖

**目标**: 确保代码质量和稳定性

**任务**:
- [ ] 单元测试
  - 工具函数测试（目标覆盖率 > 80%）
  - 游戏引擎测试
  - API路由测试
- [ ] 集成测试
  - 完整游戏流程测试
  - 存档/读档测试
  - 任务系统测试
- [ ] 端到端测试
  - 用户场景测试
  - 性能测试
  - 压力测试
- [ ] 测试自动化
  - CI/CD集成
  - 自动化测试运行
  - 测试覆盖率报告

**验收标准**:
- ✅ 单元测试覆盖率 > 80%
- ✅ 所有核心流程有集成测试
- ✅ 端到端测试通过率 100%
- ✅ CI/CD流程完整

---

### P1: 文档完善

**目标**: 提供完整的开发和用户文档

**任务**:
- [ ] API文档
  - 完整的API参考
  - 请求/响应示例
  - 错误码说明
- [ ] 开发文档
  - 架构说明
  - 开发指南
  - 贡献指南
- [ ] 用户文档
  - 用户手册
  - 常见问题FAQ
  - 游戏攻略
- [ ] 部署文档
  - 部署指南
  - 运维手册
  - 监控设置

**验收标准**:
- ✅ API文档完整准确
- ✅ 开发者可以快速上手
- ✅ 用户可以自助解决问题
- ✅ 部署流程清晰

---

## 📊 Phase 2 里程碑

### Milestone 1: 核心功能完整 (第2周结束)
- ✅ 存档系统完整可用
- ✅ 任务系统动态生成
- ✅ 错误处理完善
- ✅ 新手引导完成

### Milestone 2: 用户体验优化 (第4周结束)
- ✅ 游戏进度可视化
- ✅ 性能优化完成
- ✅ 界面美观易用
- ✅ 响应式设计完成

### Milestone 3: 高级功能实现 (第6周结束)
- ✅ NPC系统可用
- ✅ 事件线评分工作
- ✅ 线索经济管理完成

### Milestone 4: MVP发布 (第7周结束)
- ✅ 测试覆盖率达标
- ✅ 文档完整
- ✅ 所有P0功能完成
- ✅ 所有P1功能完成
- ✅ 性能指标达标

---

## 🎯 Phase 2 成功指标

### 功能指标
- ✅ 存档系统可靠性 > 99.9%
- ✅ 任务生成成功率 > 95%
- ✅ NPC对话质量评分 > 4/5
- ✅ 事件线评分准确率 > 80%

### 性能指标
- ✅ 平均响应时间 < 2秒
- ✅ P95响应时间 < 5秒
- ✅ 首屏加载时间 < 3秒
- ✅ 并发能力 > 10 QPS

### 质量指标
- ✅ 单元测试覆盖率 > 80%
- ✅ 集成测试通过率 100%
- ✅ 代码质量评分 > A
- ✅ 安全漏洞 = 0

### 用户体验指标
- ✅ 新手完成教程率 > 80%
- ✅ 平均游戏时长 > 30分钟
- ✅ 用户满意度 > 4/5
- ✅ 错误率 < 5%

---

## 🚧 风险和挑战

### 技术风险
1. **LLM稳定性**: DeepSeek V3可能不稳定
   - **缓解**: 实现多模型fallback机制
2. **性能瓶颈**: LLM调用延迟高
   - **缓解**: 实现缓存和预加载
3. **数据一致性**: 并发更新导致状态不一致
   - **缓解**: 使用事务和锁机制

### 资源风险
1. **开发时间**: 功能多可能延期
   - **缓解**: 严格优先级管理，P2/P3功能可延后
2. **LLM成本**: 大量请求成本高
   - **缓解**: 实现缓存和请求优化

### 用户体验风险
1. **学习曲线**: 用户可能不理解玩法
   - **缓解**: 完善新手引导和教程
2. **内容质量**: LLM生成内容可能质量不稳定
   - **缓解**: 实现内容过滤和质量检查

---

## 📝 下一步行动

### 立即执行 (本周)
1. [ ] 设计存档系统数据库schema
2. [ ] 实现存档API原型
3. [ ] 编写单元测试框架
4. [ ] 设计任务生成框架

### 短期计划 (2周内)
1. [ ] 完成Sprint 1所有P0任务
2. [ ] 开始Sprint 1的P1任务
3. [ ] 设置CI/CD流程
4. [ ] 性能基准测试

### 中期计划 (1个月内)
1. [ ] 完成Sprint 1和Sprint 2
2. [ ] 开始Sprint 3高级功能
3. [ ] 用户测试和反馈收集
4. [ ] 性能优化迭代

---

## 📚 相关文档

- `docs/reference/PHASE1_COMPLETE.md` - Phase 1完成报告
- `docs/reference/IMPLEMENTATION_GAP_ANALYSIS.md` - 实现差距分析
- `docs/architecture/ARCHITECTURE.md` - 架构设计文档
- `docs/features/GAME_FEATURES.md` - 游戏功能文档
- `docs/DIRECTORY_STRUCTURE.md` - 目录结构说明

---

**备注**: 本路线图是动态文档，会根据实际进展和反馈不断调整更新。
