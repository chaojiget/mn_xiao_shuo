# æŠ€æœ¯æ¶æ„è¯¦è§£

> AIè·‘å›¢æ¸¸æˆç³»ç»Ÿ - æ·±åº¦æŠ€æœ¯æ–‡æ¡£
> æ›´æ–°æ—¶é—´: 2025-11-05

## ğŸ“‘ ç›®å½•

- [æ¶æ„æ¦‚è§ˆ](#æ¶æ„æ¦‚è§ˆ)
- [LangChainé›†æˆ](#langchainé›†æˆ)
- [æµå¼è¾“å‡ºå®ç°](#æµå¼è¾“å‡ºå®ç°)
- [å­˜æ¡£ç³»ç»Ÿè®¾è®¡](#å­˜æ¡£ç³»ç»Ÿè®¾è®¡)
- [çŠ¶æ€ç®¡ç†](#çŠ¶æ€ç®¡ç†)
- [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)

---

## æ¶æ„æ¦‚è§ˆ

### ä¸‰å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯å±‚                                â”‚
â”‚  Next.js 14 + TypeScript + Zustand                         â”‚
â”‚  - é¡µé¢æ¸²æŸ“ (SSR/CSR)                                       â”‚
â”‚  - ç»„ä»¶å¤ç”¨                                                 â”‚
â”‚  - çŠ¶æ€æŒä¹…åŒ–                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ HTTP/SSE
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ä¸šåŠ¡é€»è¾‘å±‚                              â”‚
â”‚  FastAPI + LangChain 1.0                                   â”‚
â”‚  - APIè·¯ç”±å¤„ç†                                              â”‚
â”‚  - æ¸¸æˆå¼•æ“é€»è¾‘                                             â”‚
â”‚  - AI Agentè°ƒåº¦                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ•°æ® & AI å±‚                            â”‚
â”‚  SQLite + OpenRouter (LangChain ChatOpenAI)                â”‚
â”‚  - æ•°æ®æŒä¹…åŒ–                                               â”‚
â”‚  - LLMæ¨ç†                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€æœ¯é€‰å‹ç†ç”±

| æŠ€æœ¯ | é€‰å‹ç†ç”± |
|------|----------|
| **Next.js 14** | App Router æ”¯æŒ SSR/CSR æ··åˆï¼Œæ€§èƒ½ä¼˜ç§€ |
| **LangChain 1.0** | ç»Ÿä¸€çš„ LLM æ¡†æ¶ï¼Œä¸°å¯Œçš„å·¥å…·ç”Ÿæ€ |
| **OpenRouter** | ä¸€ä¸ª API è®¿é—®å¤šä¸ªæ¨¡å‹ï¼Œé™ä½ä¾èµ– |
| **Zustand** | è½»é‡çº§çŠ¶æ€ç®¡ç†ï¼Œè‡ªå¸¦æŒä¹…åŒ– |
| **shadcn/ui** | é«˜è´¨é‡ Headless UIï¼Œå¯å®šåˆ¶ |
| **SQLite** | è½»é‡çº§ï¼Œæ— éœ€é¢å¤–æœåŠ¡ï¼Œé€‚åˆå•æœºæ¸¸æˆ |
| **uv** | Python åŒ…ç®¡ç†å™¨ï¼Œæ¯” pip å¿« 10-100 å€ |

---

## LangChainé›†æˆ

### 1. Agent æ¶æ„

```python
# dm_agent_langchain.py

from langchain.agents import create_agent
from langchain_openai import ChatOpenAI

class DMAgentLangChain:
    def __init__(self, model_name: str = None):
        # åˆå§‹åŒ– OpenRouter æ¨¡å‹
        self.model = ChatOpenAI(
            model="deepseek/deepseek-v3.1-terminus",
            base_url="https://openrouter.ai/api/v1",
            api_key=os.getenv("OPENROUTER_API_KEY"),
            temperature=0.7,
            max_tokens=4096,
            streaming=True  # å¼€å¯æµå¼
        )

        # æ¸¸æˆå·¥å…·
        self.tools = ALL_GAME_TOOLS

    async def process_turn(self, session_id, player_action, game_state):
        # æ„å»ºç³»ç»Ÿæç¤ºè¯
        system_prompt = self._build_system_prompt(game_state)

        # åˆ›å»º agent
        agent = create_agent(
            model=self.model,
            tools=self.tools,
            system_prompt=system_prompt
        )

        # è°ƒç”¨ agent
        result = await agent.ainvoke({
            "messages": [{"role": "user", "content": player_action}]
        })

        return result
```

**å…³é”®ç‚¹:**
- âœ… ä½¿ç”¨ `create_agent` ç®€åŒ– agent åˆ›å»º
- âœ… `streaming=True` å¯ç”¨æµå¼è¾“å‡º
- âœ… å·¥å…·åˆ—è¡¨ç›´æ¥ä¼ å…¥ `tools` å‚æ•°

### 2. å·¥å…·å®šä¹‰

```python
# game_tools_langchain.py

from langchain.tools import tool

@tool
def add_item(item_name: str, quantity: int = 1, description: str = "") -> dict:
    """ç»™äºˆç©å®¶ç‰©å“

    Args:
        item_name: ç‰©å“åç§°
        quantity: æ•°é‡ï¼ˆé»˜è®¤1ï¼‰
        description: ç‰©å“æè¿°

    Returns:
        {"success": bool, "item": str, "quantity": int}
    """
    session_id = get_current_session_id()
    state = state_manager.get_state(session_id)

    if not state:
        return {"success": False, "error": "æ¸¸æˆçŠ¶æ€æœªåˆå§‹åŒ–"}

    # æ·»åŠ åˆ°èƒŒåŒ…
    item = InventoryItem(
        id=item_name.lower().replace(" ", "_"),
        name=item_name,
        description=description,
        quantity=quantity,
        type="misc"
    )

    state.player.inventory.append(item)

    return {
        "success": True,
        "item": item_name,
        "quantity": quantity,
        "message": f"è·å¾— {item_name} x{quantity}"
    }

# å¯¼å‡ºæ‰€æœ‰å·¥å…·
ALL_GAME_TOOLS = [
    get_player_state,
    add_item,
    remove_item,
    # ... å…±15ä¸ªå·¥å…·
]
```

**å·¥å…·è°ƒç”¨æµç¨‹:**

```
LLM å†³å®šè°ƒç”¨å·¥å…·
    â†“
è¿”å› tool_call: {
    "name": "add_item",
    "arguments": {
        "item_name": "ç«æŠŠ",
        "quantity": 3
    }
}
    â†“
LangChain è‡ªåŠ¨æ‰§è¡Œå·¥å…·
    â†“
add_item.invoke({
    "item_name": "ç«æŠŠ",
    "quantity": 3
})
    â†“
è¿”å›ç»“æœç»™ LLM
    â†“
LLM ç”Ÿæˆå™äº‹
```

### 3. System Prompt å·¥ç¨‹

```python
def _build_system_prompt(self, game_state: Dict[str, Any]) -> str:
    return f"""ä½ æ˜¯ä¸€ä¸ªå•äººè·‘å›¢æ¸¸æˆçš„æ¸¸æˆä¸»æŒäººï¼ˆDMï¼‰ã€‚

ä¸–ç•Œè®¾å®š:
{game_state.get('world', {}).get('theme', 'å¥‡å¹»ä¸–ç•Œ')}

å½“å‰çŠ¶æ€:
- ä½ç½®: {game_state.get('world', {}).get('current_location', 'æœªçŸ¥')}
- å›åˆæ•°: {game_state.get('turn_number', 0)}

ä½ çš„èŒè´£:
1. æè¿°åœºæ™¯å’Œç¯å¢ƒï¼ˆç”ŸåŠ¨ä¸”å¯Œæœ‰ç»†èŠ‚ï¼‰
2. ç®¡ç†NPCäº’åŠ¨å’Œå¯¹è¯
3. å¤„ç†ç©å®¶è¡ŒåŠ¨çš„åæœ
4. ä½¿ç”¨å·¥å…·è°ƒç”¨æ¥æ›´æ–°æ¸¸æˆçŠ¶æ€

â— å…³é”®è§„åˆ™ï¼ˆå¿…é¡»éµå®ˆï¼‰:
1. **ç‰©å“æ“ä½œè§„åˆ™**:
   - ç©å®¶æ‰”æ‰/ä½¿ç”¨/ä¸¢å¼ƒç‰©å“ â†’ å¿…é¡»è°ƒç”¨ `remove_item` å·¥å…·
   - ç©å®¶è·å¾—ç‰©å“ â†’ å¿…é¡»è°ƒç”¨ `add_item` å·¥å…·

2. **å™äº‹è¿è´¯æ€§è§„åˆ™**:
   - é˜…è¯»"æœ€è¿‘å‘ç”Ÿ"ä¸­çš„äº‹ä»¶ï¼Œ**å¿…é¡»å»¶ç»­ä¸Šä¸€å›åˆçš„åœºæ™¯**
   - ä¸è¦çªç„¶è·³è½¬åˆ°å…¶ä»–åœºæ™¯

3. **æè¿°è¯¦ç»†åº¦**:
   - æ¯ä¸ªåœºæ™¯è‡³å°‘200å­—
   - åŒ…å«ï¼šè§†è§‰ã€å¬è§‰ã€è§¦è§‰ã€æ°”å‘³ç­‰æ„Ÿå®˜ç»†èŠ‚
"""
```

**Prompt ä¼˜åŒ–å†ç¨‹:**

| ç‰ˆæœ¬ | é—®é¢˜ | æ”¹è¿› |
|------|------|------|
| v1.0 | ç‰©å“ä¸å‡å°‘ | æ·»åŠ "å¿…é¡»è°ƒç”¨ remove_item" |
| v1.1 | åœºæ™¯è·³è½¬ | æ·»åŠ "å»¶ç»­ä¸Šä¸€å›åˆåœºæ™¯" |
| v1.2 | æè¿°å¤ªçŸ­ | è¦æ±‚ 200-400 å­— + æ„Ÿå®˜ç»†èŠ‚ |
| v1.3 | Contextä¼˜å…ˆçº§æ··ä¹± | å°†"æœ€è¿‘å‘ç”Ÿ"ç§»åˆ°æœ€å‰ |

---

## æµå¼è¾“å‡ºå®ç°

### 1. åç«¯æµå¼ç”Ÿæˆ

```python
# game_engine.py

async def process_turn_stream(
    self,
    request: GameTurnRequest
) -> AsyncIterator[Dict[str, Any]]:
    """å¤„ç†æ¸¸æˆå›åˆï¼ˆæµå¼ï¼‰"""
    try:
        # 1. å…ˆå®Œæ•´å¤„ç†å›åˆ
        response = await self.process_turn(request)

        # 2. å°†æ—ç™½æŒ‰å¥å­åˆ†å‰²
        sentences = response.narration.split("ã€‚")
        for sentence in sentences:
            if sentence.strip():
                # é€å¥å‘é€
                yield {
                    "type": "text",
                    "content": sentence + "ã€‚"
                }
                # å¯é€‰ï¼šæ·»åŠ å»¶è¿Ÿæ¨¡æ‹Ÿæ‰“å­—æ•ˆæœ
                # await asyncio.sleep(0.1)

        # 3. å‘é€actions
        for action in response.actions:
            yield {
                "type": "action",
                "action": action
            }

        # 4. å‘é€å®Œæˆä¿¡å·
        yield {
            "type": "done",
            "metadata": {
                "hints": response.hints,
                "suggestions": response.suggestions,
                "turn": request.currentState.world.time
            }
        }

    except Exception as e:
        yield {
            "type": "error",
            "error": str(e)
        }
```

**ä¸ºä»€ä¹ˆä¸ç›´æ¥æµå¼è°ƒç”¨LLM?**

ç›®å‰å®ç°æ˜¯å…ˆå®Œæ•´å¤„ç†ï¼Œå†åˆ†å¥å‘é€ã€‚ä¼˜ç‚¹ï¼š
- âœ… ç®€å•å¯é 
- âœ… å¯ä»¥åœ¨å‘é€å‰éªŒè¯å®Œæ•´æ€§
- âœ… ç¡®ä¿å·¥å…·è°ƒç”¨å®Œæˆåå†å‘é€

æœªæ¥ä¼˜åŒ–æ–¹å‘ï¼š
- ğŸ”„ çœŸæ­£çš„æµå¼è°ƒç”¨ LLM
- ğŸ”„ å®æ—¶å‘é€ LLM token
- ğŸ”„ å¹¶è¡Œæ‰§è¡Œå·¥å…·è°ƒç”¨

### 2. FastAPI SSE ç«¯ç‚¹

```python
# game_api.py

@router.post("/turn/stream")
async def process_turn_stream(request: GameTurnRequestModel):
    """å¤„ç†æ¸¸æˆå›åˆï¼ˆæµå¼ï¼‰"""
    async def generate():
        try:
            state = GameState(**request.currentState)

            turn_request = GameTurnRequest(
                playerInput=request.playerInput,
                currentState=state
            )

            # æµå¼ç”Ÿæˆ
            async for chunk in game_engine.process_turn_stream(turn_request):
                # å‘é€ SSE æ ¼å¼æ•°æ®
                yield f"data: {json.dumps(chunk, ensure_ascii=False)}\n\n"

            # å‘é€æœ€ç»ˆçŠ¶æ€
            yield f"data: {json.dumps({'type': 'state', 'state': state.model_dump()}, ensure_ascii=False)}\n\n"

        except Exception as e:
            error_data = {"type": "error", "error": str(e)}
            yield f"data: {json.dumps(error_data)}\n\n"

    return StreamingResponse(
        generate(),
        media_type="text/event-stream",
        headers={
            "Cache-Control": "no-cache",
            "Connection": "keep-alive",
        }
    )
```

**SSE æ ¼å¼:**
```
data: {"type": "text", "content": "ä½ å‘åŒ—èµ°å»ã€‚"}

data: {"type": "text", "content": "å‰æ–¹å‡ºç°ä¸€åº§åŸé—¨ã€‚"}

data: {"type": "done", "metadata": {...}}

data: {"type": "state", "state": {...}}


```

### 3. å‰ç«¯æµå¼æ¥æ”¶

```typescript
// DmInterface.tsx

const handleSendMessage = async () => {
  const response = await fetch(`${apiUrl}/api/game/turn/stream`, {
    method: 'POST',
    body: JSON.stringify({ playerInput, currentState })
  });

  const reader = response.body?.getReader();
  const decoder = new TextDecoder();

  let buffer = '';
  let fullNarration = '';

  while (true) {
    const { done, value } = await reader.read();
    if (done) break;

    // è§£ç 
    buffer += decoder.decode(value, { stream: true });

    // å¤„ç† SSE æ ¼å¼
    const lines = buffer.split('\n\n');
    buffer = lines.pop() || '';

    for (const line of lines) {
      if (line.startsWith('data: ')) {
        const data = JSON.parse(line.slice(6));

        if (data.type === 'text') {
          fullNarration += data.content;
          setStreamingText(fullNarration); // å®æ—¶æ›´æ–°UI
        }
      }
    }
  }

  // å®Œæˆåæ·»åŠ åˆ°å†å²
  setMessages(prev => [...prev, {
    role: 'assistant',
    content: fullNarration
  }]);
};
```

**å…³é”®æŠ€æœ¯:**
- `ReadableStream` - æµå¼è¯»å–å“åº”
- `TextDecoder` - è§£ç å­—èŠ‚æµ
- Buffer ç®¡ç† - å¤„ç†ä¸å®Œæ•´çš„è¡Œ

---

## å­˜æ¡£ç³»ç»Ÿè®¾è®¡

### 1. æ•°æ®åº“ Schema

```sql
-- æ¸¸æˆå­˜æ¡£è¡¨
CREATE TABLE game_saves (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT NOT NULL,
    slot_id INTEGER NOT NULL,        -- 0=è‡ªåŠ¨, 1-10=æ‰‹åŠ¨
    save_name TEXT NOT NULL,
    game_state TEXT NOT NULL,        -- JSONåºåˆ—åŒ–
    metadata TEXT,                   -- å…ƒæ•°æ®
    screenshot_url TEXT,             -- å¯é€‰æˆªå›¾
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, slot_id)         -- åŒä¸€ç”¨æˆ·çš„åŒä¸€æ§½ä½å”¯ä¸€
);

-- ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_user_id ON game_saves(user_id);
CREATE INDEX idx_slot_id ON game_saves(slot_id);
CREATE INDEX idx_updated_at ON game_saves(updated_at);
```

**ä¸ºä»€ä¹ˆä½¿ç”¨ TEXT å­˜å‚¨ JSON?**
- SQLite æ²¡æœ‰åŸç”Ÿ JSON ç±»å‹
- TEXT + JSONåºåˆ—åŒ–è¶³å¤Ÿç®€å•é«˜æ•ˆ
- æ”¯æŒ JSON å‡½æ•° (SQLite 3.38+)

### 2. SaveService å®ç°

```python
# save_service.py

class SaveService:
    def save_game(
        self,
        user_id: str,
        slot_id: int,
        save_name: str,
        game_state: Dict[str, Any],
        auto_save: bool = False
    ) -> int:
        """ä¿å­˜æ¸¸æˆ"""
        # éªŒè¯æ§½ä½
        if not 0 <= slot_id <= 10:
            raise ValueError("æ§½ä½å¿…é¡»åœ¨ 0-10 ä¹‹é—´")

        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()

        try:
            # æå–å…ƒæ•°æ®
            metadata = {
                "turn_number": game_state.get("turn_number", 0),
                "location": game_state.get("player", {}).get("location"),
                "hp": game_state.get("player", {}).get("hp"),
            }

            # åºåˆ—åŒ–
            game_state_json = json.dumps(game_state, ensure_ascii=False)
            metadata_json = json.dumps(metadata, ensure_ascii=False)

            # Upsert (æ’å…¥æˆ–æ›´æ–°)
            cursor.execute("""
                INSERT INTO game_saves (user_id, slot_id, save_name, game_state, metadata, updated_at)
                VALUES (?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
                ON CONFLICT(user_id, slot_id) DO UPDATE SET
                    save_name = excluded.save_name,
                    game_state = excluded.game_state,
                    metadata = excluded.metadata,
                    updated_at = CURRENT_TIMESTAMP
            """, (user_id, slot_id, save_name, game_state_json, metadata_json))

            save_id = cursor.lastrowid
            conn.commit()

            return save_id

        finally:
            conn.close()

    def get_latest_auto_save(self, user_id: str):
        """è·å–æœ€æ–°è‡ªåŠ¨ä¿å­˜"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()

        try:
            cursor.execute("""
                SELECT id, game_state, metadata, created_at
                FROM game_saves
                WHERE user_id = ? AND slot_id = 0
                ORDER BY updated_at DESC
                LIMIT 1
            """, (user_id,))

            row = cursor.fetchone()
            if not row:
                return None

            return {
                "auto_save_id": row[0],
                "game_state": json.loads(row[1]),
                "turn_number": json.loads(row[2]).get("turn_number"),
                "created_at": row[3]
            }

        finally:
            conn.close()
```

### 3. è‡ªåŠ¨ä¿å­˜è§¦å‘

```python
# game_api.py

@router.post("/turn")
async def process_turn(request: GameTurnRequestModel):
    # ... å¤„ç†å›åˆ ...

    # è‡ªåŠ¨ä¿å­˜
    if save_service:
        try:
            auto_save_id = save_service.save_game(
                user_id="default_user",
                slot_id=0,
                save_name="è‡ªåŠ¨ä¿å­˜",
                game_state=state.model_dump(),
                auto_save=True
            )
            print(f"[DEBUG] ğŸ’¾ è‡ªåŠ¨ä¿å­˜æˆåŠŸ: {auto_save_id}")
        except Exception as e:
            print(f"[WARNING] è‡ªåŠ¨ä¿å­˜å¤±è´¥: {e}")
            # ä¸é˜»æ–­æ¸¸æˆæµç¨‹
```

**è‡ªåŠ¨ä¿å­˜ç­–ç•¥:**
- âœ… æ¯å›åˆè‡ªåŠ¨è§¦å‘
- âœ… ä¿å­˜åˆ°æ§½ä½0ï¼ˆä¸“ç”¨ï¼‰
- âœ… å¤±è´¥ä¸å½±å“æ¸¸æˆ
- âœ… åªä¿ç•™æœ€æ–°ä¸€ä»½

### 4. å‰ç«¯æ¢å¤æœºåˆ¶

```typescript
// page.tsx

useEffect(() => {
  const loadOrInitGame = async () => {
    try {
      // 1. å°è¯•åŠ è½½è‡ªåŠ¨ä¿å­˜
      const autoSave = await apiClient.getLatestAutoSave();

      if (autoSave.success && autoSave.game_state) {
        // 2. æ¢å¤çŠ¶æ€
        setGameState(autoSave.game_state);
        setSessionId(autoSave.game_state.session_id || `session_${Date.now()}`);

        // 3. æç¤ºç”¨æˆ·
        toast({
          title: "âœ… è¿›åº¦å·²æ¢å¤",
          description: `ç»§ç»­ç¬¬ ${autoSave.game_state.turn_number || 0} å›åˆçš„å†’é™©`
        });
      } else {
        // æ²¡æœ‰è‡ªåŠ¨ä¿å­˜ï¼Œåˆå§‹åŒ–æ–°æ¸¸æˆ
        await initGame();
      }
    } catch (error) {
      // åŠ è½½å¤±è´¥ï¼Œåˆå§‹åŒ–æ–°æ¸¸æˆ
      await initGame();
    }
  };

  loadOrInitGame();
}, []);
```

**DmInterface å†å²æ¢å¤:**

```typescript
// DmInterface.tsx

useEffect(() => {
  if (gameState?.log && gameState.log.length > 0 && messages.length === 0) {
    console.log('[DmInterface] æ¢å¤å†å²æ¶ˆæ¯:', gameState.log.length);

    const historicalMessages = gameState.log.map((entry, index) => ({
      id: `history_${index}`,
      role: entry.actor === 'player' ? 'player' : 'dm',
      content: entry.text,
      timestamp: new Date(entry.timestamp || Date.now())
    }));

    setMessages(historicalMessages);
  }
}, [gameState]);
```

---

## çŠ¶æ€ç®¡ç†

### 1. Zustand Store

```typescript
// gameStore.ts

import { create } from 'zustand';
import { persist, createJSONStorage } from 'zustand/middleware';

interface GameStore {
  gameState: GameState | null;
  setGameState: (state: GameState) => void;
  resetGame: () => void;
}

export const useGameStore = create<GameStore>()(
  persist(
    (set) => ({
      gameState: null,

      setGameState: (state) => {
        console.log('[GameStore] ğŸ’¾ ä¿å­˜æ¸¸æˆçŠ¶æ€åˆ° localStorage');
        set({ gameState: state });
      },

      resetGame: () => {
        console.log('[GameStore] ğŸ—‘ï¸ æ¸…é™¤æ¸¸æˆè¿›åº¦');
        set({ gameState: null });
      }
    }),
    {
      name: 'game-storage',
      storage: createJSONStorage(() => localStorage),
      partialize: (state) => ({
        // åªä¿å­˜ gameStateï¼Œä¸ä¿å­˜ UI çŠ¶æ€
        gameState: state.gameState
      }),
      onRehydrateStorage: () => (state) => {
        if (state?.gameState) {
          console.log('[GameStore] ğŸ”„ ä» localStorage æ¢å¤æ¸¸æˆè¿›åº¦');
        }
      }
    }
  )
);
```

**ä¸ºä»€ä¹ˆé€‰æ‹© Zustand?**
- âœ… æ¯” Redux è½»é‡ï¼ˆ~1KBï¼‰
- âœ… ä¸éœ€è¦ Provider
- âœ… å†…ç½® persist ä¸­é—´ä»¶
- âœ… TypeScript æ”¯æŒå¥½

### 2. åŒå±‚å­˜å‚¨ç­–ç•¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          æµè§ˆå™¨ç«¯                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Zustand Store (å†…å­˜)      â”‚    â”‚
â”‚  â”‚  - å½“å‰æ¸¸æˆçŠ¶æ€             â”‚    â”‚
â”‚  â”‚  - UI çŠ¶æ€                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚              â”‚ persist             â”‚
â”‚              â–¼                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  localStorage              â”‚    â”‚
â”‚  â”‚  - ç¼“å­˜æ¸¸æˆçŠ¶æ€ (ä»…å‰ç«¯)   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ API
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          æœåŠ¡å™¨ç«¯                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  SQLite Database           â”‚    â”‚
â”‚  â”‚  - æŒä¹…åŒ–å­˜æ¡£ï¼ˆå¯é ï¼‰       â”‚    â”‚
â”‚  â”‚  - æ”¯æŒå¤šæ§½ä½               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸ºä»€ä¹ˆéœ€è¦åŒå±‚?**
- localStorage: å¿«é€Ÿæ¢å¤ï¼Œå‡å°‘ç½‘ç»œè¯·æ±‚
- SQLite: å¯é æŒä¹…åŒ–ï¼Œæ”¯æŒè·¨è®¾å¤‡ï¼ˆæœªæ¥ï¼‰

**åŒæ­¥ç­–ç•¥:**
- æ¯å›åˆåç«¯è‡ªåŠ¨ä¿å­˜åˆ° SQLite
- å‰ç«¯ Zustand åŒæ­¥æ›´æ–° localStorage
- é¡µé¢åŠ è½½æ—¶ä¼˜å…ˆä»åç«¯åŠ è½½

---

## æ€§èƒ½ä¼˜åŒ–

### 1. å‰ç«¯ä¼˜åŒ–

**ç»„ä»¶ä¼˜åŒ–:**
```typescript
// ä½¿ç”¨ React.memo é¿å…ä¸å¿…è¦çš„æ¸²æŸ“
export const DmMessage = React.memo(({ message }) => {
  return <div>{message.content}</div>;
});

// ä½¿ç”¨ useCallback ç¼“å­˜å›è°ƒ
const handleSendMessage = useCallback(async () => {
  // ...
}, [gameState, input]);
```

**è™šæ‹Ÿæ»šåŠ¨:**
```typescript
// å¯¹äºé•¿æ¶ˆæ¯åˆ—è¡¨ï¼Œè€ƒè™‘ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨
import { useVirtualizer } from '@tanstack/react-virtual';

const rowVirtualizer = useVirtualizer({
  count: messages.length,
  getScrollElement: () => scrollRef.current,
  estimateSize: () => 100,
});
```

**ä»£ç åˆ†å‰²:**
```typescript
// æ‡’åŠ è½½éé¦–å±ç»„ä»¶
const WorldMap = lazy(() => import('@/components/game/WorldMap'));
```

### 2. åç«¯ä¼˜åŒ–

**å¼‚æ­¥ä¼˜åŒ–:**
```python
# ä½¿ç”¨ asyncio.gather å¹¶è¡Œæ‰§è¡Œ
async def process_turn(self, request):
    # å¹¶è¡Œæ‰§è¡Œå¤šä¸ªå¼‚æ­¥ä»»åŠ¡
    results = await asyncio.gather(
        self.llm_backend.generate(...),
        self.db.save_state(...),
        return_exceptions=True
    )
```

**æ•°æ®åº“è¿æ¥æ± :**
```python
# ä½¿ç”¨è¿æ¥æ± ï¼ˆæœªæ¥ä¼˜åŒ–ï¼‰
from sqlalchemy.pool import QueuePool

pool = QueuePool(
    creator=lambda: sqlite3.connect(db_path),
    pool_size=5,
    max_overflow=10
)
```

**ç¼“å­˜ System Prompt:**
```python
# ç¼“å­˜ä¸å˜çš„ System Prompt éƒ¨åˆ†
@lru_cache(maxsize=1)
def get_base_system_prompt():
    return """ä½ æ˜¯ä¸€ä¸ªæ¸¸æˆä¸»æŒäºº..."""
```

### 3. æµå¼è¾“å‡ºä¼˜åŒ–

**åˆ†æ‰¹å‘é€:**
```python
# ä¸æ˜¯é€å­—å‘é€ï¼Œè€Œæ˜¯æŒ‰å¥å­å‘é€
sentences = narration.split("ã€‚")
for sentence in sentences:
    yield {"type": "text", "content": sentence + "ã€‚"}
    # å¯é€‰å»¶è¿Ÿ
    await asyncio.sleep(0.05)
```

**å‹ç¼©ä¼ è¾“:**
```python
# å¯¹äºå¤§æ•°æ®ï¼Œä½¿ç”¨ gzip å‹ç¼©
from fastapi.responses import StreamingResponse
import gzip

async def compressed_stream():
    async for chunk in generate():
        compressed = gzip.compress(chunk.encode())
        yield compressed

return StreamingResponse(
    compressed_stream(),
    headers={"Content-Encoding": "gzip"}
)
```

---

## ç›‘æ§ä¸è°ƒè¯•

### 1. æ—¥å¿—ç³»ç»Ÿ

**åç«¯æ—¥å¿—é…ç½®:**
```python
import logging

logging.basicConfig(
    level=logging.DEBUG,
    format='%(asctime)s [%(levelname)s] %(name)s: %(message)s',
    datefmt='%H:%M:%S'
)

logger = logging.getLogger(__name__)

# ä½¿ç”¨
logger.info("ğŸ® å¼€å§‹å¤„ç†æ¸¸æˆå›åˆ")
logger.debug(f"ğŸ“ ç©å®¶è¾“å…¥: {player_input}")
logger.error(f"âŒ é”™è¯¯: {error}")
```

**å‰ç«¯æ—¥å¿—:**
```typescript
// ç»Ÿä¸€çš„æ—¥å¿—å‡½æ•°
const log = {
  info: (msg: string) => console.log(`[Game] â„¹ï¸ ${msg}`),
  error: (msg: string) => console.error(`[Game] âŒ ${msg}`),
  debug: (msg: string) => console.debug(`[Game] ğŸ› ${msg}`)
};

log.info('æ¸¸æˆåˆå§‹åŒ–å®Œæˆ');
```

### 2. æ€§èƒ½ç›‘æ§

```typescript
// æµ‹é‡ API å“åº”æ—¶é—´
const startTime = performance.now();
await apiClient.processTurn(...);
const endTime = performance.now();
console.log(`API å“åº”æ—¶é—´: ${endTime - startTime}ms`);
```

### 3. é”™è¯¯è¿½è¸ª

```python
# ä½¿ç”¨ traceback æ‰“å°å®Œæ•´é”™è¯¯å †æ ˆ
try:
    # ...
except Exception as e:
    logger.error(f"é”™è¯¯: {str(e)}")
    import traceback
    logger.error(traceback.format_exc())
```

---

## å®‰å…¨è€ƒè™‘

### 1. API å®‰å…¨

**ç¯å¢ƒå˜é‡ä¿æŠ¤:**
```bash
# æ•æ„Ÿä¿¡æ¯ä¸æäº¤åˆ° git
.env
.env.local
```

**è¯·æ±‚éªŒè¯:**
```python
from pydantic import BaseModel, validator

class GameTurnRequest(BaseModel):
    playerInput: str
    currentState: GameState

    @validator('playerInput')
    def validate_input(cls, v):
        if len(v) > 1000:
            raise ValueError('è¾“å…¥è¿‡é•¿')
        return v
```

### 2. XSS é˜²æŠ¤

```typescript
// React è‡ªåŠ¨è½¬ä¹‰ï¼Œä½†è¦æ³¨æ„ dangerouslySetInnerHTML
<div>{message.content}</div>  // âœ… å®‰å…¨

// å¦‚æœå¿…é¡»ä½¿ç”¨ HTML
import DOMPurify from 'dompurify';
<div dangerouslySetInnerHTML={{
  __html: DOMPurify.sanitize(html)
}} />
```

### 3. SQL æ³¨å…¥é˜²æŠ¤

```python
# ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
cursor.execute(
    "SELECT * FROM game_saves WHERE user_id = ?",
    (user_id,)  # âœ… å®‰å…¨
)

# ä¸è¦æ‹¼æ¥ SQL
cursor.execute(
    f"SELECT * FROM game_saves WHERE user_id = '{user_id}'"  # âŒ å±é™©
)
```

---

## æœªæ¥ä¼˜åŒ–æ–¹å‘

### çŸ­æœŸä¼˜åŒ–
- [ ] çœŸæ­£çš„æµå¼ LLM è°ƒç”¨ï¼ˆå®æ—¶ tokenï¼‰
- [ ] WebSocket æ›¿ä»£ SSEï¼ˆåŒå‘é€šä¿¡ï¼‰
- [ ] å­˜æ¡£æˆªå›¾åŠŸèƒ½
- [ ] æ‰¹é‡åŠ è½½å†å²æ¶ˆæ¯ï¼ˆåˆ†é¡µï¼‰

### ä¸­æœŸä¼˜åŒ–
- [ ] å¤šç”¨æˆ·æ”¯æŒï¼ˆç”¨æˆ·è®¤è¯ï¼‰
- [ ] äº‘ç«¯å­˜æ¡£ï¼ˆS3/OSSï¼‰
- [ ] å‘é‡æ•°æ®åº“ï¼ˆè¯­ä¹‰æœç´¢ï¼‰
- [ ] Redis ç¼“å­˜å±‚

### é•¿æœŸä¼˜åŒ–
- [ ] æœåŠ¡å™¨éƒ¨ç½²ï¼ˆDocker + K8sï¼‰
- [ ] è´Ÿè½½å‡è¡¡
- [ ] å®æ—¶å¤šäººæ¨¡å¼
- [ ] AI æ¨¡å‹å¾®è°ƒ

---

**æ–‡æ¡£ç»´æŠ¤**: Claude Code
**æœ€åæ›´æ–°**: 2025-11-05
**ç‰ˆæœ¬**: 1.0
