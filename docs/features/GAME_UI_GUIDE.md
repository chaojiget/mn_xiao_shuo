# 游戏界面使用指南

完整的 React/Next.js 游戏界面组件，用于单人跑团游戏（DM Agent 模式）。

## 快速开始

### 1. 启动服务

```bash
# 从项目根目录启动所有服务
./scripts/start/start_all_with_agent.sh
```

这将启动：
- LiteLLM Proxy (端口 4000)
- 后端服务 (端口 8000)
- 前端服务 (端口 3000)

### 2. 访问游戏

打开浏览器访问：
```
http://localhost:3000/game/play
```

### 3. 开始游戏

游戏会自动初始化，你将看到：
- 左侧：游戏状态面板（HP、资源、背包）
- 中间：DM 交互界面（聊天窗口）
- 右侧：任务追踪和 NPC 列表

---

## 界面布局

### 桌面端（宽屏）

```
┌─────────────────────────────────────────────────────────┐
│ 顶部工具栏                                               │
│ [地下城主模式]                      [保存游戏] [退出]    │
├──────────┬─────────────────────────┬───────────────────┤
│          │                         │                   │
│  游戏状态 │      DM 交互界面         │   任务追踪器       │
│          │                         │                   │
│  - HP    │  ┌──────────────────┐   │  • 激活的任务      │
│  - 金币  │  │ DM: 欢迎来到...  │   │  • 可接取的任务    │
│  - 经验  │  │                  │   │  • 已完成的任务    │
│  - 位置  │  │ 玩家: 我向北走   │   │                   │
│  - 背包  │  │                  │   ├───────────────────┤
│          │  │ DM: 你看到...    │   │                   │
│          │  └──────────────────┘   │   NPC 对话         │
│          │                         │                   │
│          │  [输入框.............]   │  • 附近的 NPC      │
│          │            [发送]        │  • 关系指示器      │
│          │                         │  • 对话选项        │
└──────────┴─────────────────────────┴───────────────────┘
```

### 移动端

```
┌─────────────────────┐
│ [☰] 地下城主模式     │
├─────────────────────┤
│                     │
│   DM 交互界面        │
│                     │
│   - 消息历史         │
│   - 玩家输入         │
│                     │
├─────────────────────┤
│ [状态] [任务] [NPC] │
└─────────────────────┘
```

---

## 核心功能

### 1. DM 交互

**功能**：
- 实时对话界面
- 流式文本显示
- 工具调用可视化
- WebSocket 自动连接

**使用方法**：
1. 在输入框输入你的行动（如："我向北走"）
2. 按 Enter 发送（Shift+Enter 换行）
3. DM 会回复叙述和结果
4. 工具调用（如检定、物品变化）会高亮显示

**示例对话**：
```
玩家: 我搜索房间
DM: 使用工具: roll_check (感知检定)
DM: 你仔细搜索了房间，在书架后面发现了一个暗门...
```

### 2. 任务追踪

**功能**：
- 显示所有任务
- 按状态分类（激活/可接取/已完成）
- 实时进度更新
- 完成动画

**任务状态**：
- **激活中**：当前正在进行的任务
- **可接取**：可以开始的新任务
- **已完成**：已完成的任务历史

**查看任务详情**：
- 任务描述
- 目标列表（带进度）
- 奖励预览（经验/金币/物品）

### 3. NPC 对话

**功能**：
- NPC 列表（按位置筛选）
- 关系指示器（好感度/信任度）
- NPC 详细信息
- 记忆系统

**关系等级**：
- 陌生人 (-100 ~ 0)
- 熟人 (0 ~ 30)
- 朋友 (30 ~ 60)
- 盟友 (60 ~ 100)
- 敌人 (< -50)

**与 NPC 互动**：
1. 点击 NPC 卡片查看详情
2. 查看性格特质、说话风格、目标
3. 点击"开始对话"按钮
4. 在 DM 界面中进行对话

### 4. 游戏状态

**显示内容**：
- **HP**：生命值（实时更新）
- **资源**：金币、经验、其他资源
- **背包**：物品列表（按类型分类）
- **位置**：当前所在地点
- **元数据**：回合数、会话 ID

**背包管理**：
- 点击物品查看详情
- 显示物品效果
- 按类型筛选（武器/防具/消耗品/任务物品）

---

## 保存与加载

### 保存游戏

1. 点击顶部工具栏的"保存游戏"按钮
2. 游戏自动保存到槽位 1
3. 显示保存成功提示

**自动保存**：
- 每 5 个回合自动保存一次
- 退出游戏前会提示保存

### 加载存档

```
访问：http://localhost:3000/game
选择存档槽位
点击"继续游戏"
```

---

## WebSocket 连接

### 实时模式（推荐）

当 WebSocket 连接成功时：
- 左下角显示绿点 "WebSocket 已连接"
- 文本流式显示（更流畅）
- 工具调用实时推送

### HTTP 模式（降级）

当 WebSocket 连接失败时：
- 自动降级到 HTTP 模式
- 左下角显示红点 "使用 HTTP 模式"
- 功能完全正常，但无流式显示

---

## 工具调用可视化

当 DM 使用工具时，会显示黄色高亮框：

```
┌─────────────────────────────────────────┐
│ ⚡ 使用工具: roll_check                  │
│ {                                       │
│   "type": "perception",                 │
│   "dc": 15,                             │
│   "result": 18                          │
│ }                                       │
└─────────────────────────────────────────┘
```

**常见工具**：
- `roll_check` - 技能检定
- `modify_hp` - HP 变化
- `add_item` - 获得物品
- `remove_item` - 失去物品
- `change_location` - 移动位置
- `create_quest` - 创建任务
- `update_quest_progress` - 更新任务进度

---

## 快捷操作

### 键盘快捷键

- `Enter` - 发送消息
- `Shift + Enter` - 换行
- `Ctrl + S` - 保存游戏

### 快捷建议

DM 回复后会显示建议行动：
```
[查看背包] [环顾四周] [向北走] [查看任务]
```

点击建议可快速输入。

---

## 响应式设计

### 桌面端（宽度 > 1280px）

- 三栏布局
- 所有功能同时可见
- 最佳体验

### 平板端（宽度 1024px - 1280px）

- 两栏布局（DM + 状态）
- 任务和 NPC 通过底部导航访问

### 手机端（宽度 < 1024px）

- 单栏布局（仅 DM 界面）
- 通过汉堡菜单访问状态
- 通过底部导航访问任务和 NPC

---

## 故障排除

### 游戏无法初始化

**症状**：一直显示"正在初始化游戏..."

**解决方案**：
1. 检查后端服务是否运行（端口 8000）
2. 检查浏览器控制台错误
3. 刷新页面重试

### WebSocket 无法连接

**症状**：左下角显示红点

**原因**：
- 后端未实现 WebSocket 路由
- 网络防火墙阻止

**解决方案**：
- 不影响功能，自动降级到 HTTP 模式
- 或检查后端 WebSocket 实现

### 任务/NPC 不显示

**症状**：任务追踪器显示"暂无激活的任务"

**原因**：
- 游戏刚开始，还没有任务
- 后端 API 返回空数据

**解决方案**：
1. 与 DM 对话，触发任务创建
2. 检查 `/api/game/quests` API 响应

### 状态不更新

**症状**：HP/金币等数据不变化

**原因**：
- 后端没有返回更新的 `gameState`
- 前端状态没有正确同步

**解决方案**：
1. 检查 API 响应中的 `updatedState` 字段
2. 查看浏览器控制台错误
3. 刷新页面重新加载

---

## API 端点测试

### 测试游戏初始化

```bash
curl -X POST http://localhost:8000/api/game/init \
  -H "Content-Type: application/json" \
  -d '{}'
```

### 测试发送行动

```bash
curl -X POST http://localhost:8000/api/game/turn \
  -H "Content-Type: application/json" \
  -d '{
    "playerInput": "我向北走",
    "currentState": {...}
  }'
```

### 测试任务列表

```bash
curl http://localhost:8000/api/game/quests
```

### 测试 NPC 列表

```bash
curl http://localhost:8000/api/game/npcs?status=active
```

---

## 开发调试

### 查看状态

打开浏览器控制台，输入：
```javascript
// 查看当前游戏状态
console.log(useGameStore.getState().gameState);

// 查看任务列表
console.log(useGameStore.getState().quests);

// 查看 NPC 列表
console.log(useGameStore.getState().npcs);
```

### 启用详细日志

在组件中添加：
```typescript
useEffect(() => {
  console.log('[Component] gameState:', gameState);
}, [gameState]);
```

### 模拟数据

如果后端未实现，可以使用模拟数据：
```typescript
// 在组件中
useEffect(() => {
  // 模拟游戏状态
  setGameState({
    session_id: 'test-session',
    turn_number: 1,
    current_location: '测试地点',
    hp: 100,
    max_hp: 100,
    resources: { gold: 50, exp: 0 },
    inventory: [],
    active_quests: [],
    completed_quests: [],
    npc_relationships: {},
    world_flags: {},
    timestamp: new Date().toISOString(),
  });
}, []);
```

---

## 下一步

### 功能扩展

1. **多存档支持**：允许用户选择存档槽位（1-10）
2. **快照系统**：支持回退到之前的回合
3. **自定义主题**：暗色/亮色模式切换
4. **语音输入**：使用浏览器 Speech API
5. **音效系统**：添加背景音乐和音效

### 优化建议

1. **性能优化**：使用 React.memo 减少重渲染
2. **离线支持**：使用 Service Worker 缓存
3. **测试覆盖**：添加 Jest + React Testing Library 测试
4. **无障碍**：添加 ARIA 标签和键盘导航

---

## 相关文档

- [组件详细文档](../../web/frontend/components/game/README.md)
- [类型定义](../../web/frontend/types/game.ts)
- [状态管理](../../web/frontend/stores/gameStore.ts)
- [后端 API](../../web/backend/api/game_api.py)
- [Phase 2 实现文档](../implementation/CLAUDE_AGENT_SDK_IMPLEMENTATION.md)

---

## 反馈与支持

如果遇到问题：
1. 查看浏览器控制台错误
2. 检查后端日志（`logs/backend.log`）
3. 查看故障排除文档（`docs/troubleshooting/TROUBLESHOOTING.md`）
