# 新 UI 组件测试指南

## 概述

新的 AI 思考过程可视化组件已经集成到游戏聊天页面 (`/game/play`)，本指南将帮助你测试这些新功能。

## 准备工作

### 1. 确认模型配置

检查 `.env` 文件：

```bash
DEFAULT_MODEL=moonshotai/kimi-k2-thinking
```

### 2. 启动服务

```bash
# 完整启动（推荐）
./scripts/start/start_all_with_agent.sh

# 或单独启动
# 后端
cd web/backend
uv run uvicorn main:app --reload --port 8000

# 前端
cd web/frontend
npm run dev
```

### 3. 访问游戏页面

打开浏览器访问:
```
http://localhost:3000/game/play
```

---

## 测试新组件

### ✅ 组件 1: ThinkingProcess（思考过程展示）

**位置**: 聊天区域顶部

**如何触发**:
1. 在聊天框输入一个复杂问题：
   ```
   我想探索这个洞穴，里面可能有什么危险？
   ```

2. Kimi K2 模型会开始思考，你应该看到：
   ```
   ┌────────────────────────────────────┐
   │ 🧠 AI 思考过程        ▼     3 步   │
   ├────────────────────────────────────┤
   │  ① 分析玩家意图                    │
   │     玩家想要探索并了解风险...      │
   │  ② 评估游戏状态                    │
   │     需要检查玩家位置和能力...      │
   │  ✓ 规划响应                        │
   │     先描述环境，再提示危险...      │
   └────────────────────────────────────┘
   ```

**预期行为**:
- 📊 显示思考步骤（如果模型支持）
- ⏱️ 每个步骤带时间戳
- 🎨 紫蓝渐变背景
- 🔄 可以点击标题折叠/展开

**测试检查清单**:
- [ ] 思考过程卡片显示
- [ ] 步骤按顺序出现
- [ ] 时间戳正确
- [ ] 折叠/展开功能正常
- [ ] 暗色模式下显示正常

---

### ✅ 组件 2: SuggestionChips（AI 建议芯片）

**位置**: 输入框上方

**如何触发**:
1. 完成一次对话后，系统可能自动生成建议
2. 或者手动点击"刷新建议"按钮

**预期显示**:
```
┌────────────────────────────────────┐
│ ✨ AI 建议                    🔄  │
├────────────────────────────────────┤
│ 🗺️ 探索周围环境 → ⚔️ 准备战斗 →  │
│ ❓ 询问NPC → ✨ 使用魔法物品 →     │
└────────────────────────────────────┘
```

**预期行为**:
- 🎨 不同类型建议有不同颜色
  - 🗺️ 探索：蓝色
  - ⚔️ 行动：红色
  - ❓ 问题：紫色
  - ✨ 创意：绿色
- 🖱️ 点击建议后自动填充到输入框
- 🔄 可以刷新建议

**测试检查清单**:
- [ ] 建议芯片显示
- [ ] 颜色正确
- [ ] 点击填充到输入框
- [ ] 悬停效果（放大）
- [ ] 刷新功能正常

---

### ✅ 组件 3: TaskProgress（任务进度列表）

**位置**: 思考过程下方，消息上方

**如何触发**:
1. 输入需要调用工具的指令：
   ```
   检查我的状态
   ```
   或
   ```
   投掷一个技能检定
   ```

**预期显示**:
```
┌────────────────────────────────────┐
│ AI 工作进度              2 / 2     │
├────────────────────────────────────┤
│ ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓      100%       │
├────────────────────────────────────┤
│  ✓ 工具调用: get_player_state      │
│     💻 14:23:45                    │
│  ✓ 工具调用: roll_check            │
│     💻 14:23:47                    │
└────────────────────────────────────┘
```

**预期行为**:
- 🔧 显示工具调用任务
- ⏳ 显示进行中状态（蓝色，旋转图标）
- ✅ 完成后变绿色，显示勾选
- 📊 整体进度条更新
- 📁 可能显示文件引用

**测试检查清单**:
- [ ] 任务列表显示
- [ ] 进行中状态（蓝色 + 旋转）
- [ ] 完成状态（绿色 + 勾选）
- [ ] 进度条正确
- [ ] 时间戳显示

---

## 完整测试流程

### 场景 1: 简单对话

**输入**: `你好，我在哪里？`

**预期**:
- ❌ 不显示思考过程（太简单）
- ❌ 不显示任务进度（无工具调用）
- ✅ 显示 AI 建议（如"探索周围"、"查看状态"）

---

### 场景 2: 探索行动

**输入**: `我想探索洞穴深处`

**预期**:
- ✅ 显示思考过程（Kimi K2 思考如何处理）
  - 步骤1: 分析玩家意图
  - 步骤2: 检查游戏状态
  - 步骤3: 规划响应
- ✅ 显示任务进度
  - 任务1: get_player_state（进行中 → 完成）
  - 任务2: roll_check（进行中 → 完成）
  - 任务3: set_location（进行中 → 完成）
- ✅ 显示 AI 建议
  - "继续前进"
  - "仔细观察"
  - "准备战斗"

---

### 场景 3: 战斗指令

**输入**: `攻击敌人`

**预期**:
- ✅ 显示思考过程
  - 步骤1: 识别战斗意图
  - 步骤2: 评估战斗力
  - 步骤3: 计算伤害
- ✅ 显示任务进度
  - 任务1: roll_check（攻击检定）
  - 任务2: update_hp（更新敌人 HP）
  - 任务3: create_quest（可能触发任务）
- ✅ 显示 AI 建议
  - "继续攻击"
  - "使用技能"
  - "撤退"

---

## 调试技巧

### 1. 查看浏览器控制台

打开开发者工具 (F12)，查看：
```javascript
// WebSocket 消息
[DM WebSocket] 收到消息: {type: "thinking_step", content: "..."}

// HTTP 流式消息
[DM Interface] 解析SSE数据: {type: "tool_call", tool: "get_player_state"}
```

### 2. 查看后端日志

```bash
cd web/backend
uv run uvicorn main:app --reload --log-level debug

# 查看思考过程检测
# 💬 叙事片段: 思考：玩家想要...
# 🔥 检测到思考步骤
```

### 3. 检查网络请求

在浏览器开发者工具 → Network 标签：
- WebSocket 连接: `ws://localhost:8000/api/dm/ws/{sessionId}`
- HTTP 流: `/api/game/turn/stream`

### 4. 验证组件状态

在 React DevTools 中查看 `DmInterface` 组件：
- `thinkingSteps`: 应该包含思考步骤数组
- `tasks`: 应该包含任务数组
- `suggestions`: 应该包含建议数组

---

## 常见问题

### Q1: 思考过程不显示

**可能原因**:
1. 模型不是 Kimi K2 Thinking
2. 后端检测逻辑未匹配模型输出格式

**解决方法**:
```bash
# 1. 确认模型
cat .env | grep DEFAULT_MODEL

# 2. 查看后端日志
cd web/backend
uv run uvicorn main:app --reload --log-level debug

# 3. 手动触发思考
# 在聊天框输入复杂问题
```

---

### Q2: 建议芯片不显示

**可能原因**:
1. `suggestions` 数组为空
2. 组件渲染条件未满足

**解决方法**:
```tsx
// 在 DmInterface.tsx 中手动设置建议（临时测试）
useEffect(() => {
  setSuggestions([
    { id: '1', text: '探索', category: 'explore' },
    { id: '2', text: '战斗', category: 'action' },
  ]);
}, []);
```

---

### Q3: 任务进度不显示

**可能原因**:
1. DM Agent 没有调用工具
2. 工具调用事件未正确传递

**解决方法**:
```bash
# 1. 确认后端工具调用日志
# 🔧 工具调用开始: get_player_state

# 2. 确认前端接收事件
# [DM Interface] 收到事件: {type: "tool_call", tool: "get_player_state"}

# 3. 手动触发工具调用
# 输入: "检查我的状态"
```

---

## 视觉检查清单

### 亮色模式
- [ ] 思考过程：紫蓝渐变背景
- [ ] 建议芯片：淡色背景 + 彩色边框
- [ ] 任务进度：白色背景 + 彩色状态

### 暗色模式
- [ ] 思考过程：深色背景 + 浅色文字
- [ ] 建议芯片：半透明背景 + 彩色边框
- [ ] 任务进度：深色背景 + 彩色状态

### 动画效果
- [ ] 思考步骤：淡入动画
- [ ] 进行中任务：旋转图标
- [ ] 完成任务：勾选弹入
- [ ] 建议芯片：悬停放大

### 响应式设计
- [ ] 桌面端 (>1024px): 三栏布局
- [ ] 平板端 (768-1024px): 两栏布局
- [ ] 移动端 (<768px): 单栏布局

---

## 性能测试

### 1. 流式性能

**测试**: 输入一个长问题，观察流式输出

**预期**:
- 思考过程逐步显示（不是一次性）
- 叙事文本平滑流式输出
- 无明显卡顿或延迟

### 2. 内存使用

**测试**: 进行 10 个回合对话

**预期**:
- 思考步骤自动清理（不累积）
- 任务列表控制在合理数量
- 无内存泄漏警告

---

## 截图对比

### 预期效果（ASCII 参考）

```
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃            游戏聊天界面                ┃
┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┫
┃ ┌──────────────────────────────────┐ ┃
┃ │ 🧠 AI 思考过程       ▼      3 步 │ ┃  <- 新组件 1
┃ ├──────────────────────────────────┤ ┃
┃ │  ① 分析玩家意图                  │ ┃
┃ │  ② 评估游戏状态                  │ ┃
┃ │  ✓ 规划响应策略                  │ ┃
┃ └──────────────────────────────────┘ ┃
┃                                      ┃
┃ ┌──────────────────────────────────┐ ┃
┃ │ AI 工作进度            2 / 2     │ ┃  <- 新组件 2
┃ ├──────────────────────────────────┤ ┃
┃ │ ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓      100%      │ ┃
┃ ├──────────────────────────────────┤ ┃
┃ │  ✓ 工具调用: get_player_state    │ ┃
┃ │  ✓ 工具调用: roll_check          │ ┃
┃ └──────────────────────────────────┘ ┃
┃                                      ┃
┃ [玩家消息...]                        ┃
┃ [DM 回复...]                         ┃
┃                                      ┃
┃ ┌──────────────────────────────────┐ ┃
┃ │ ✨ AI 建议                  🔄  │ ┃  <- 新组件 3
┃ ├──────────────────────────────────┤ ┃
┃ │ 🗺️ 探索 → ⚔️ 战斗 → ❓ 询问 →   │ ┃
┃ └──────────────────────────────────┘ ┃
┃                                      ┃
┃ [ 输入框... ]            [ 发送 ]   ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
```

---

## 测试报告模板

```markdown
# UI 组件测试报告

**测试日期**: 2025-11-08
**测试人员**: [你的名字]
**测试环境**:
- 浏览器: Chrome/Firefox/Safari
- 操作系统: macOS/Windows/Linux
- 屏幕分辨率: 1920x1080

## ThinkingProcess 组件
- [ ] 显示正常
- [ ] 折叠/展开正常
- [ ] 时间戳正确
- [ ] 动画流畅
- [ ] 暗色模式正常

## SuggestionChips 组件
- [ ] 显示正常
- [ ] 颜色正确
- [ ] 点击填充正常
- [ ] 悬停效果正常
- [ ] 刷新功能正常

## TaskProgress 组件
- [ ] 显示正常
- [ ] 状态更新正常
- [ ] 进度条准确
- [ ] 时间戳正确
- [ ] 文件引用显示

## 问题和建议
[记录发现的问题和改进建议]

## 截图
[附上实际截图]
```

---

## 下一步

测试完成后，请：
1. 填写测试报告
2. 提交问题反馈
3. 提出改进建议
4. 分享使用体验

---

## 相关文档

- [AI 思考过程可视化 UI](../features/AI_THINKING_UI.md)
- [Kimi K2 集成指南](../features/KIMI_K2_INTEGRATION.md)
- [UI 组件演示](../features/UI_COMPONENTS_DEMO.md)
- [更新日志](../UPDATES_2025_11_08.md)
