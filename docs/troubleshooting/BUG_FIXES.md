# Bug 修复记录

## 2025-11-01 修复

### 问题 1: 任务重复激活

**症状:**
- 每个回合都显示"激活任务: xxx"
- 日志中出现大量重复的任务激活记录

**原因:**
```python
# game/quests.py 中的逻辑错误
# 之前的代码没有正确判断任务是否已存在
if not existing_quest:  # 这里 existing_quest 可能是 None 或 已存在任务
```

**修复:**
```python
# 明确检查任务是否为 None
if existing_quest is None:
    # 只有不存在时才激活
```

**验证:**
- 启动新游戏
- 第一回合应该看到任务激活
- 后续回合不应再激活相同任务

---

### 问题 2: 任务事件显示不清晰

**症状:**
- 任务事件混在旁白末尾
- 难以区分哪些是剧情，哪些是系统消息

**修复:**
```python
# 添加明显的分隔线和标题
quest_narration = "\n\n" + "=" * 40 + "\n"
quest_narration += "📋 任务更新:\n"
quest_narration += "\n".join(f"  • {event}" for event in quest_events)
quest_narration += "\n" + "=" * 40
```

**显示效果:**
```
你环顾四周,发现这里是一个宁静的广场...

========================================
📋 任务更新:
  • 📜 新任务激活: 初次探险
  • ✅ 任务进度: 初次探险 - 环顾四周
========================================
```

---

### 问题 3: 地图未更新 (待确认)

**需要检查的点:**

1. **工具调用:** LLM 是否正确调用了 `set_location`?
   ```python
   # 检查 actions 中是否有:
   {
     "type": "set_location",
     "arguments": {"location_id": "forest"}
   }
   ```

2. **节点发现:** `discover_location` 是否被调用?
   ```python
   # 需要 LLM 明确调用:
   tools.discover_location("forest")
   ```

3. **地图数据传递:** 前端是否正确接收到更新后的地图?
   ```typescript
   // 检查 gameState.map
   console.log(gameState.map.currentNodeId)  // 应该变化
   console.log(gameState.map.nodes)  // discovered 应该更新
   ```

**可能的原因:**

**原因 A: LLM 没有调用工具**
- DeepSeek 可能不理解需要调用 `set_location`
- 解决: 改进 system prompt,明确说明必须使用工具

**原因 B: 工具调用了但地图没更新**
- 检查 `game_tools.py` 中的 `set_location` 实现
- 确认 `discover_location` 是否同步更新 nodes

**原因 C: 前端状态未刷新**
- 检查 `applyActions` 是否正确应用状态变化
- 确认 React 组件是否重新渲染

---

### 问题 4: 背包未更新 (待确认)

**类似地图问题,需要检查:**

1. LLM 是否调用了 `add_item`?
2. `add_item` 是否正确执行?
3. 前端是否正确显示?

---

## 调试方法

### 1. 查看后端日志

```bash
# 查看实时日志
tail -f logs/backend.log

# 或者直接查看后台进程输出
# (如果使用 start_all_with_agent.sh)
```

**应该看到:**
```
[INFO] 加载任务: first_adventure - 初次探险
[INFO] 加载任务: find_cave_key - 寻找失落的钥匙
[INFO] 激活任务: first_adventure  # 只在第一次
[DEBUG] Turn processed successfully
```

### 2. 查看前端 Console

打开浏览器开发者工具 (F12):

```javascript
// 检查游戏状态
console.log(gameState)

// 检查任务
console.log(gameState.quests)

// 检查地图
console.log(gameState.map)

// 检查背包
console.log(gameState.player.inventory)
```

### 3. 检查 Network 请求

在 Network 标签中:

```
1. 找到 /api/game/turn 请求
2. 查看 Request Payload (发送的状态)
3. 查看 Response (返回的数据)
4. 确认 actions 数组中有哪些工具调用
```

---

## 测试步骤

### 测试任务系统

1. **启动新游戏**
   ```
   访问 http://localhost:3000/game
   点击 "开始游戏"
   ```

2. **观察初始任务**
   ```
   应该看到:
   ========================================
   📋 任务更新:
     • 📜 新任务激活: 初次探险
     • 📜 新任务激活: 寻找失落的钥匙
   ========================================
   ```

3. **触发任务进度**
   ```
   输入: 环顾四周

   应该看到:
   ========================================
   📋 任务更新:
     • ✅ 任务进度: 初次探险 - 环顾四周
   ========================================
   ```

4. **完成任务**
   ```
   输入: 向北走

   应该看到:
   ========================================
   📋 任务更新:
     • ✅ 任务进度: 初次探险 - 尝试移动
     • 🎉 任务完成: 初次探险
     • 💫 获得 20 点经验
     • 🎁 获得物品: 治疗药水 x2
   ========================================
   ```

5. **检查右侧任务栏**
   ```
   - 应该显示活跃任务
   - 完成的任务应该消失
   ```

### 测试地图更新

1. **查看初始地图**
   ```
   - 应该只有 "起点" 可见
   - 其他节点显示 "???"
   ```

2. **移动到新地点**
   ```
   输入: 向北走 / 进入森林

   期望:
   - 当前位置标记移动
   - 新地点变为可见
   - discovered 状态更新
   ```

3. **如果没更新**
   ```
   检查:
   1. Console 中的 actions 数组
   2. 是否有 set_location 调用
   3. gameState.map.currentNodeId 是否变化
   ```

### 测试背包系统

1. **查看初始背包**
   ```
   应该是空的或有初始物品
   ```

2. **触发物品获取**
   ```
   输入: 拾起剑 / 搜索宝箱

   期望:
   - actions 中有 add_item 调用
   - 背包显示新物品
   ```

3. **检查数量**
   ```
   重复拾取同一物品
   - 数量应该增加而不是新增条目
   ```

---

## 待修复问题

### P0 - 高优先级

- [ ] **确认地图更新机制**
  - 测试 set_location 是否正常工作
  - 确保 LLM 知道需要调用工具

- [ ] **确认背包更新机制**
  - 测试 add_item 是否正常工作
  - 确保前端正确显示

### P1 - 中优先级

- [ ] **改进 LLM Prompt**
  - 明确说明必须使用工具进行状态变更
  - 提供工具调用示例

- [ ] **添加更多调试信息**
  - 在元数据中返回工具调用结果
  - 前端显示最近的工具调用

### P2 - 低优先级

- [ ] **任务系统增强**
  - 任务失败条件
  - 任务链(前置任务)
  - 隐藏任务

---

## 下次测试清单

- [ ] 从头开始新游戏
- [ ] 完成教程任务
- [ ] 移动到森林
- [ ] 拾取物品
- [ ] 查看地图是否更新
- [ ] 查看背包是否有物品
- [ ] 检查任务栏显示
- [ ] 保存并读档

---

**最后更新**: 2025-11-01
**修复版本**: v0.3.1
